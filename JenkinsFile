pipeline {
    agent any

    environment {
        IMAGE_TAG = "${env.BUILD_NUMBER}"
        DOCKER_HUB_REPO = "saravana2002/devops-task"
        AWS_REGION = "ap-south-1"
        ECS_CLUSTER = "adq-ecs-cluster"
        ECS_SERVICE = "adq-service"
        TASK_FAMILY = "adq-task"
    }

    stages {
        stage('Checkout Code') {
            steps {
                git url: 'https://github.com/SaravanaNani/devops-task.git', branch: 'main'
            }
        }

        stage('Build Docker Image') {
            steps {
                sh """
                    docker build -t ${DOCKER_HUB_REPO}:${IMAGE_TAG} .
                """
            }
        }

        stage('Push Docker Image') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'dockerhub-creds', 
                                                 usernameVariable: 'DOCKER_USER', 
                                                 passwordVariable: 'DOCKER_PASS')]) {
                    sh """
                        echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin
                        docker push ${DOCKER_HUB_REPO}:${IMAGE_TAG}
                    """
                }
            }
        }

        stage('Update ECS Service') {
            steps {
                sh """
                    # Get current task definition ARN
                    TASK_DEF_ARN=\$(aws ecs describe-services \
                        --cluster ${ECS_CLUSTER} \
                        --services ${ECS_SERVICE} \
                        --query 'services[0].taskDefinition' \
                        --output text)

                    echo "Current Task Definition ARN: \$TASK_DEF_ARN"

                    # Get container definitions from current task
                    CONTAINER_DEF=\$(aws ecs describe-task-definition \
                        --task-definition \$TASK_DEF_ARN \
                        --query 'taskDefinition.containerDefinitions' \
                        --output json)

                    # Register new task definition with updated image
                    NEW_TASK_DEF_ARN=\$(aws ecs register-task-definition \
                        --family ${TASK_FAMILY} \
                        --network-mode awsvpc \
                        --requires-compatibilities FARGATE \
                        --cpu 256 \
                        --memory 512 \
                        --container-definitions "\$(echo \$CONTAINER_DEF | jq '.[0].image=\"${DOCKER_HUB_REPO}:${IMAGE_TAG}\"') " \
                        --query 'taskDefinition.taskDefinitionArn' \
                        --output text)

                    echo "New Task Definition ARN: \$NEW_TASK_DEF_ARN"

                    # Update ECS service
                    aws ecs update-service \
                        --cluster ${ECS_CLUSTER} \
                        --service ${ECS_SERVICE} \
                        --task-definition \$NEW_TASK_DEF_ARN \
                        --force-new-deployment
                """
            }
        }
    }

    post {
        success {
            echo "Deployment completed successfully! üéâ"
        }
        failure {
            echo "Pipeline failed ‚ùå"
        }
    }
}
